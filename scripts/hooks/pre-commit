#!/usr/bin/env bash
# ACFS Pre-commit Hook: Auto-regenerate manifest outputs
#
# When acfs.manifest.yaml or packages/manifest/** change,
# this hook regenerates scripts/generated/** and stages the changes.
#
# Install: ./scripts/hooks/install.sh
# Bypass: git commit --no-verify
# CI enforces: bun run generate --diff (blocks merge on drift)

set -euo pipefail

# Check if manifest-related files are staged
if git diff --cached --name-only | grep -qE '^(acfs\.manifest\.yaml|packages/manifest/)'; then
    echo "ğŸ“¦ Manifest changes detected, regenerating scripts/generated/..."

    # Check if bun is available
    if ! command -v bun &>/dev/null; then
        echo "âš ï¸  bun not found. Skipping auto-regeneration."
        echo "   Run manually: cd packages/manifest && bun run generate"
        exit 0
    fi

    # Regenerate
    (cd packages/manifest && bun install --silent && bun run generate) || {
        echo "âŒ Generator failed. Fix issues before committing."
        exit 1
    }

    # Stage regenerated files
    git add scripts/generated/
    echo "âœ… Regenerated and staged scripts/generated/"
fi
